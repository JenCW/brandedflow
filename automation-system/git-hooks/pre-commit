#!/bin/bash
# Git pre-commit hook to prompt for CONTEXT.md updates
# Install: ln -s ../../automation-system/git-hooks/pre-commit .git/hooks/pre-commit

PROJECT_ROOT="$(git rev-parse --show-toplevel)"
CONTEXT_FILE="$PROJECT_ROOT/docs/CONTEXT.md"
CONTEXT_PYTHON="$PROJECT_ROOT/automation-system/context_manager.py"

# Check if CONTEXT.md has been modified
if git diff --cached --name-only | grep -q "docs/CONTEXT.md"; then
    echo "✅ CONTEXT.md is being updated - good!"
    exit 0
fi

# Check how old CONTEXT.md is
if [ -f "$CONTEXT_FILE" ]; then
    # Get days since last modification
    if command -v python3 &> /dev/null && [ -f "$CONTEXT_PYTHON" ]; then
        DAYS_OLD=$(python3 "$CONTEXT_PYTHON" check 2>/dev/null | grep -oE '[0-9]+' | head -1)
        
        if [ -n "$DAYS_OLD" ] && [ "$DAYS_OLD" -gt 3 ]; then
            echo ""
            echo "⚠️  WARNING: CONTEXT.md is $DAYS_OLD days old"
            echo ""
            echo "Consider updating CONTEXT.md before committing."
            echo "This file should be updated when:"
            echo "  - Priorities change"
            echo "  - Client status changes"
            echo "  - Major decisions are made"
            echo ""
            read -p "Continue with commit anyway? (y/N) " -n 1 -r
            echo ""
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo "Commit cancelled. Update CONTEXT.md and try again."
                exit 1
            fi
        fi
    fi
fi

exit 0

